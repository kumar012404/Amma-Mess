<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amma Mess Tracker</title>
    <link rel="icon" href="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f35b.png" type="image/png">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22;
            --success: #27ae60;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 100px;
            /* Space for summary footer on mobile */
        }

        header {
            background: linear-gradient(135deg, var(--primary), #34495e);
            color: white;
            padding: 1rem;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        @media (max-width: 600px) {
            header {
                padding: 0.8rem;
                margin-bottom: 0.8rem;
            }

            header h1 {
                font-size: 1.3rem;
            }

            header p {
                font-size: 0.8rem;
            }

            .menu-manage-btn {
                width: 35px;
                height: 35px;
                right: 10px;
                font-size: 1rem;
            }
        }

        header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 0.3rem;
        }

        header p {
            font-weight: 300;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Sidebar Styling */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: var(--primary);
            color: white;
            z-index: 2500;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 2rem 1.5rem;
            box-shadow: 20px 0 50px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem 1.2rem;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-item i {
            width: 24px;
            font-size: 1.1rem;
            color: var(--accent);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2400;
            display: none;
        }

        .menu-toggle {
            position: absolute;
            left: 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 600px) {
            .menu-toggle {
                left: 10px;
                font-size: 1.2rem;
            }
        }

        .header-actions {
            position: absolute;
            right: 20px;
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }

        .header-btn i {
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: var(--accent);
        }

        .header-btn:hover i {
            transform: scale(1.15);
        }

        .header-btn.popular:hover {
            background: #e74c3c;
        }

        .header-btn.manage:hover {
            transform: rotate(90deg);
        }

        @media (max-width: 600px) {
            .header-actions {
                right: 10px;
                gap: 8px;
            }

            .header-btn {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }
        }

        /* Manage Panel Refinement */
        .manage-panel {
            background: white;
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            margin-bottom: 2.5rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }

        .manage-item-row {
            transition: all 0.3s ease;
        }

        .manage-item-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-color: var(--accent) !important;
        }

        .manage-item-row button {
            transition: all 0.2s ease;
        }

        .manage-item-row button:hover {
            transform: scale(1.1);
            opacity: 0.9;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .close-btn {
            background: #f8f9fa;
            border: none;
            color: var(--text-muted);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #fee;
            color: #e74c3c;
            transform: rotate(90deg);
        }

        .panel-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-header h3 i {
            color: var(--accent);
            background: rgba(230, 126, 34, 0.1);
            padding: 10px;
            border-radius: 12px;
        }

        .add-item-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper i {
            position: absolute;
            left: 15px;
            color: var(--text-muted);
            font-size: 1rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid #f0f2f5;
            border-radius: 14px;
            font-size: 1rem;
            background: #f8fafc;
            transition: all 0.3s;
            color: var(--primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 8px 20px rgba(230, 126, 34, 0.1);
        }

        .save-btn-container {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .save-item-btn {
            background: linear-gradient(135deg, var(--primary), #1a252f);
            color: white;
            border: none;
            padding: 1rem 3rem;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.4s;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(44, 62, 80, 0.3);
        }

        .save-item-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(44, 62, 80, 0.4);
            background: linear-gradient(135deg, var(--accent), #d35400);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Session Switcher */
        .session-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 1.5rem;
        }

        .session-btn {
            background: var(--card-bg);
            border: 2px solid transparent;
            padding: 0.8rem 0.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        .session-btn i {
            font-size: 1.2rem;
        }

        .session-btn.morning {
            color: #f1c40f;
        }

        .session-btn.afternoon {
            color: #e67e22;
        }

        .session-btn.night {
            color: #9b59b6;
        }

        .session-btn.active {
            border-color: currentColor;
            transform: translateY(-5px);
            background: white;
        }

        .session-btn:not(.active) {
            opacity: 0.6;
        }

        /* Items Section */
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .toggle-view-btn {
            background: rgba(44, 62, 80, 0.05);
            border: 1px solid rgba(44, 62, 80, 0.1);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-view-btn.active {
            background: var(--accent);
            color: white !important;
            border-color: var(--accent);
        }

        .toggle-view-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: scale(1.1);
        }

        /* Overall Items Styling */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 2rem;
        }

        .item-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid #eee;
            transition: transform 0.2s;
        }

        .item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            z-index: 10;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
            color: white;

        }

        .edit-btn {
            background: rgba(52, 152, 219, 0.9);
        }

        .edit-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .delete-btn {
            background: rgba(231, 76, 60, 0.9);
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .item-image {
            width: 100%;
            aspect-ratio: 16 / 10;
            object-fit: cover;
            background: #f0f0f0;
        }

        .item-details {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }

        .item-card:active {
            transform: scale(0.98);
        }

        .item-info h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            height: 2.6em;
            overflow: hidden;
            line-height: 1.3;
        }

        .item-info .price {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--accent);
        }

        .item-controls {
            display: flex;
            gap: 4px;
            margin-top: auto;
        }

        .qty-input {
            width: 32px;
            height: 30px;
            padding: 2px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
        }

        .add-btn {
            flex: 1;
            height: 30px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-btn:hover {
            background: #219150;
        }

        /* Popular Badge Styles */
        .popular-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #e67e22, #f1c40f);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse-popular 2s infinite;
        }

        @keyframes pulse-popular {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 10px rgba(230, 126, 34, 0.2);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(230, 126, 34, 0.5);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 4px 10px rgba(230, 126, 34, 0.2);
            }
        }

        .popular-badge i {
            font-size: 0.8rem;
            color: #fff;
        }

        @media (max-width: 768px) {
            .popular-badge {
                top: 3px;
                left: 3px;
                padding: 1px 4px;
                font-size: 0.45rem;
                gap: 2px;
            }

            .popular-badge i {
                font-size: 0.5rem;
            }
        }

        .item-card.is-popular {
            border: 2px solid rgba(230, 126, 34, 0.3);
        }

        .add-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .qty-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 2px;
            margin-bottom: 6px;
            border: 1px solid #e9ecef;
        }

        .qty-btn {
            background: white;
            border: 1px solid #dee2e6;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            color: var(--primary);
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .qty-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .qty-input {
            width: 30px;
            background: transparent;
            border: none;
            text-align: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--primary);
            -moz-appearance: textfield;
            outline: none;
        }

        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Summary Section */
        .summary-panel {
            margin-top: 3rem;
            background: var(--primary);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(44, 62, 80, 0.2);
        }

        .top-selling-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        .top-selling-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .top-item-row {
            margin-bottom: 12px;
        }

        .top-item-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .top-item-bar-bg {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .top-item-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #f39c12);
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @media (max-width: 768px) {
            .top-selling-section {
                margin-top: 15px;
                padding-top: 10px;
            }

            .top-item-row {
                margin-bottom: 8px;
            }

            .top-item-info {
                font-size: 0.75rem;
            }
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }

        .stat-box.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .stat-box.clickable:hover {
            background: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-box.clickable:active {
            transform: scale(0.98);
        }

        .stat-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
        }

        /* Extreme Mobile Adjustments for 4-column POS */
        @media (max-width: 768px) {
            body {
                padding-bottom: 90px;
            }

            .items-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }

            .item-image {
                aspect-ratio: 16 / 9;
            }

            .item-details {
                padding: 4px;
                gap: 4px;
            }

            .item-info h3 {
                font-size: 0.8rem;
                height: 2.4em;
                margin-bottom: 2px;
            }

            .item-info .price {
                font-size: 0.9rem;
            }

            .qty-input {
                width: 24px;
                height: 26px;
                font-size: 0.75rem;
                border-radius: 4px;
            }

            .add-btn {
                height: 28px;
                font-size: 0.75rem;
                border-radius: 6px;
                padding: 2px;
            }

            .action-btn {
                width: 22px !important;
                height: 22px !important;
                font-size: 0.65rem !important;
            }

            .item-actions {
                top: 4px;
                right: 4px;
                gap: 3px;
            }

            .toggle-view-btn {
                width: 26px;
                height: 26px;
                font-size: 0.8rem;
            }

            .add-btn:hover {
                transform: none !important;
            }

            .action-btn:hover {
                transform: none !important;
            }

            .qty-btn:hover {
                background: #f1f1f1;
            }

            /* Reuse monthly card style for generic modals */
            .modal-card {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 25px;
                border-radius: 24px;
                width: 90%;
                max-width: 450px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                z-index: 2001;
                display: none;
                animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            }

            #popular-items-panel {
                background: var(--primary);
                color: white;
            }

            #popular-items-panel .top-selling-title {
                color: white !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding-bottom: 15px;
                margin-bottom: 20px;
                font-size: 1.2rem;
            }

            #popular-items-panel .top-item-info,
            #popular-items-panel .top-item-info span {
                color: white !important;
            }

            @keyframes modalIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -45%) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }

            #current-bill-panel.modal-card {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                transform: translateY(100%);
                width: 100%;
                max-width: none;
                max-height: 80vh;
                border-radius: 24px 24px 0 0;
                display: block !important;
                /* Force block to allow transform transitions */
                visibility: hidden;
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.4s;
                padding: 20px;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
                background: white !important;
                color: var(--primary) !important;
                margin: 0;
            }

            #current-bill-panel.modal-card.open {
                transform: translateY(0);
                visibility: visible;
            }

            .floating-cart-btn {
                position: fixed;
                bottom: 110px;
                right: 20px;
                background: var(--accent);
                color: white;
                width: 65px;
                height: 65px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.6rem;
                box-shadow: 0 15px 35px rgba(230, 126, 34, 0.4);
                cursor: pointer;
                z-index: 1500;
                border: 3px solid white;
                opacity: 0;
                pointer-events: none;
                transform: scale(0.5) translateY(20px);
                transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                transform-origin: center;
            }

            .floating-cart-btn.active {
                opacity: 1;
                pointer-events: auto;
                transform: scale(1) translateY(0);
            }

            .cart-badge {
                position: absolute;
                top: -5px;
                right: -5px;
                background: #e74c3c;
                color: white;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                font-size: 0.75rem;
                font-weight: 800;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid white;
            }

            @keyframes popIn {
                from {
                    transform: scale(0);
                    opacity: 0;
                }

                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            /* Detailed History Modal Specifics */
            #history-items-panel {
                max-width: 600px;
                max-height: 85vh;
                overflow: hidden;
                display: none;
                flex-direction: column;
            }

            #history-items-panel.open {
                display: flex !important;
            }

            .history-scroll-area {
                overflow-y: auto;
                flex: 1;
                padding-right: 5px;
                -webkit-overflow-scrolling: touch;
                /* Smooth scroll for iOS */
                margin-bottom: 10px;
            }

            .detailed-bill-card {
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 15px;
                padding: 15px;
                margin-bottom: 15px;
            }

            .bill-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 1px dashed #dee2e6;
            }

            .bill-id {
                font-weight: 800;
                color: var(--primary);
                font-size: 0.9rem;
            }

            .bill-time {
                font-size: 0.75rem;
                color: var(--text-muted);
            }

            .bill-items-list {
                font-size: 0.85rem;
                color: #555;
            }

            .bill-item-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 4px;
            }

            .bill-footer {
                margin-top: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: 700;
                color: var(--primary);
            }

            .summary-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                margin: 0;
                border-radius: 20px 20px 0 0;
                padding: 15px;
                z-index: 1000;
                background: var(--primary);
                box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
            }

            .summary-header {
                display: flex !important;
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: none;
            }

            .summary-header h2 {
                font-size: 1rem;
            }
        }

        .stat-box {
            flex: 1;
            padding: 1.5rem;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            border-radius: 16px;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .stat-box.clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
        }

        .stat-box .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 700;
        }

        .stat-box .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-box.clickable {
            cursor: pointer;
            user-select: none;
        }

        .report-btn {
            height: 40px;
        }


        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 5000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            opacity: 0;
            pointer-events: none;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Loading Spinner */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-bottom-color: var(--accent);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Orders List Styles - Line Wise */
        .orders-list {
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .order-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            gap: 12px;
            animation: fadeIn 0.3s ease;
            font-size: 0.9rem;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-num {
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.8rem;
            width: 25px;
        }

        .order-details-row {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .order-main-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-name-qty {
            font-weight: 600;
            color: var(--primary);
        }

        .order-time-tag {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .payment-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dot-cash {
            background: var(--success);
        }

        .dot-online {
            background: #3498db;
        }

        .order-total-price {
            font-weight: 700;
            color: var(--primary);
        }

        .delete-order-btn {
            background: transparent;
            color: #ccc;
            border: none;
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .delete-order-btn:hover {
            color: #ff4d4d;
            transform: scale(1.2);
        }

        .session-group-header {
            background: #f8fafc;
            padding: 8px 15px;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
        }

        .session-group-header i {
            font-size: 0.8rem;
            color: var(--accent);
        }

        @media (max-width: 600px) {
            .order-item {
                padding: 8px 10px;
                gap: 8px;
            }

            .order-name-qty {
                font-size: 0.85rem;
            }

            .order-total-price {
                font-size: 0.85rem;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .loading-overlay {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        /* Payment Selector Styles */
        .payment-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 1.5rem;
            background: #e9ecef;
            padding: 5px;
            border-radius: 16px;
        }

        .payment-btn {
            background: transparent;
            border: none;
            padding: 0.8rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .payment-btn i {
            font-size: 1.1rem;
        }

        .payment-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: scale(1.02);
        }

        .payment-btn.cash.active {
            color: var(--success);
        }

        .payment-btn.online.active {
            color: #3498db;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 600px) {
            header {
                padding: 0.6rem;
            }

            header h1 {
                font-size: 1.1rem;
            }

            .container {
                padding: 0 8px;
                padding-bottom: 150px;
            }

            .session-selector {
                gap: 5px;
            }

            .session-btn {
                padding: 10px 4px;
                font-size: 0.75rem;
            }

            .payment-btn {
                padding: 12px 5px;
                font-size: 0.8rem;
            }

            .summary-stats {
                gap: 6px;
            }

            .stat-box {
                padding: 8px 4px;
            }

            .stat-label {
                font-size: 0.5rem;
            }

            .stat-value {
                font-size: 0.85rem;
            }

            .report-btn {
                padding: 10px 5px;
                font-size: 0.75rem;
            }

            /* Monthly view adjustments */
            .monthly-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .month-picker-container {
                flex-direction: column;
                align-items: stretch;
            }

            .section-title {
                font-size: 1rem;
                margin: 1.5rem 0 1rem 0;
            }
        }

        /* Reports Section Styles */
        .analytics-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 1.5rem;
        }

        .report-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.8rem;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .report-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .monthly-card {
            background: white;
            padding: 25px;
            border-radius: 24px;
            margin-top: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            display: none;
            position: relative;
            z-index: 1001;
        }

        @media (max-width: 600px) {
            .monthly-card {
                position: fixed;
                top: 5%;
                left: 15px;
                right: 15px;
                bottom: auto;
                max-height: 80vh;
                margin: 0;
                overflow-y: auto;
                z-index: 2001;
                border: 2px solid var(--accent);
            }

            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                z-index: 2000;
                display: none;
            }
        }

        .monthly-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }

        .month-stat {
            background: #f8fafc;
            padding: 15px;
            border-radius: 16px;
            border: 1px solid #edf2f7;
            text-align: center;
        }

        .month-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .month-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .month-picker-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 1rem;
            background: #f8fafc;
            padding: 10px;
            border-radius: 12px;
        }

        .month-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
        }

        .modal-overlay {
            display: none;
        }

        /* Desktop/Laptop Enhancements (1024px and above) */
        @media (min-width: 1024px) {

            /* Container expansion for better use of screen space */
            .container {
                max-width: 1100px;
                transition: max-width 0.3s ease;
            }

            .items-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            /* Premium Modal Styling for Desktop */
            .modal-card {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                max-width: 600px !important;
                padding: 35px !important;
                border-radius: 28px !important;
                box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5) !important;
                max-height: 85vh;
                overflow-y: auto;
                z-index: 3000 !important;
                display: none;
                /* Hidden by default on PC */
            }

            /* Smooth fade-in animation for desktop */
            @keyframes desktopModalIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -48%) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }

            .modal-card {
                animation: desktopModalIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
            }

            /* Popular Items Panel - Desktop Specific */
            #popular-items-panel {
                max-width: 650px !important;
                padding: 40px !important;
            }

            #popular-items-panel h3 {
                font-size: 1.8rem !important;
                color: white !important;
            }

            #popular-items-panel .top-item-row {
                margin-bottom: 25px;
            }

            #popular-items-panel .top-item-info {
                font-size: 1.1rem;
                margin-bottom: 10px;
                color: white !important;
            }

            #popular-items-panel .top-item-info span {
                color: white !important;
            }

            #popular-items-panel .top-item-bar-bg {
                height: 14px;
                background: rgba(255, 255, 255, 0.08);
            }

            #popular-items-panel .top-item-bar-fill {
                box-shadow: 0 0 15px rgba(230, 126, 34, 0.4);
            }

            /* History Panel - Desktop Specific */
            #history-items-panel {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                max-width: 750px !important;
                width: 90% !important;
                padding: 35px !important;
                background: white;
                border-radius: 28px;
                box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5);
                z-index: 3000 !important;
                max-height: 85vh;
                overflow: hidden;
                display: none;
                /* Start hidden */
                flex-direction: column;
            }

            #history-items-panel .modal-header {
                margin-bottom: 25px;
                padding-bottom: 20px;
                border-bottom: 2px solid #f0f3f6;
            }

            #history-items-panel .modal-header h3 {
                font-size: 1.8rem;
                color: var(--primary);
            }

            .history-scroll-area {
                overflow-y: auto;
                max-height: calc(85vh - 150px);
                padding-right: 10px;
            }

            /* Custom scrollbar for history */
            .history-scroll-area::-webkit-scrollbar {
                width: 8px;
            }

            .history-scroll-area::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }

            .history-scroll-area::-webkit-scrollbar-thumb {
                background: var(--accent);
                border-radius: 10px;
            }

            .history-scroll-area::-webkit-scrollbar-thumb:hover {
                background: #d35400;
            }

            /* Monthly View Panel - Desktop Specific */
            #monthly-view-panel,
            .monthly-card {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                max-width: 650px !important;
                padding: 35px !important;
                background: white;
                border-radius: 28px;
                box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5);
                z-index: 3000 !important;
                max-height: 85vh;
                overflow-y: auto;
            }

            .monthly-header h3 {
                font-size: 1.6rem;
                color: var(--primary);
            }

            .month-picker-container {
                gap: 12px;
            }

            .month-input {
                font-size: 1rem;
                padding: 12px 16px;
            }

            .monthly-grid {
                gap: 20px;
            }

            .month-stat {
                padding: 20px;
                border-radius: 16px;
            }

            .month-label {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }

            .month-value {
                font-size: 1.8rem;
            }

            /* Blurred Overlay for Desktop */
            .modal-overlay {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.7) !important;
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
                z-index: 2900 !important;
                animation: fadeInOverlay 0.3s ease !important;
                display: none;
                /* Hidden on load */
            }

            @keyframes fadeInOverlay {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            /* Enhanced Bill Cards for Desktop */
            .detailed-bill-card {
                background: white;
                border: 2px solid #f0f3f6;
                border-radius: 20px;
                padding: 24px;
                margin-bottom: 20px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                transition: all 0.3s ease;
            }

            .detailed-bill-card:hover {
                border-color: var(--accent);
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }

            .bill-header {
                margin-bottom: 18px;
                padding-bottom: 15px;
                border-bottom: 2px dashed #e9ecef;
            }

            .bill-id {
                font-size: 1.2rem;
                font-weight: 800;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .bill-time {
                font-size: 0.85rem;
                background: #f8f9fa;
                padding: 6px 14px;
                border-radius: 20px;
            }

            .bill-items-list {
                font-size: 1rem;
                line-height: 1.8;
                margin: 18px 0;
            }

            .bill-item-row {
                padding: 6px 0;
            }

            .bill-footer {
                margin-top: 18px;
                padding-top: 18px;
                border-top: 2px solid #f0f3f6;
                font-size: 1.2rem;
            }

            /* Summary Panel Desktop Enhancements */
            .summary-panel {
                border-radius: 24px;
                padding: 2.5rem;
            }

            .stat-box {
                padding: 1.5rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>

    <header>
        <button class="menu-toggle" onclick="window.toggleSidebar()" title="Menu">
            <i class="fas fa-bars"></i>
        </button>
        <div class="header-content">
            <h1>Amma Mess</h1>
            <p id="current-date-display"></p>
        </div>
        <div class="header-actions">

            <button class="header-btn manage" onclick="window.toggleManagePanel()" title="Manage Menu">
                <i class="fas fa-edit"></i>
            </button>
        </div>
    </header>

    <div class="container">
        <!-- Manage Items Panel (Hidden by default) -->
        <section id="manage-panel" class="manage-panel" style="display: none;">
            <div class="panel-header">
                <h3><i class="fas fa-plus-circle"></i> Add New Menu Item</h3>
                <button class="close-btn" onclick="toggleManagePanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-item-form" class="add-item-form">
                <div class="form-group">
                    <label><i class="fas fa-utensils"></i> Item Name</label>
                    <div class="input-wrapper">
                        <i class="fas fa-edit"></i>
                        <input type="text" id="new-item-name" placeholder="e.g. Masala Dosa" required>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Price ()</label>
                    <div class="input-wrapper">
                        <i class="fas fa-indian-rupee-sign"></i>
                        <input type="number" id="new-item-price" placeholder="60" required>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-image"></i> Image URL</label>
                    <div class="input-wrapper">
                        <i class="fas fa-link"></i>
                        <input type="url" id="new-item-image" placeholder="https://image-link.com">
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-clock"></i> Session</label>
                    <div class="input-wrapper">
                        <i class="fas fa-calendar-day"></i>
                        <select id="new-item-session" required>
                            <option value="morning">Morning</option>
                            <option value="afternoon">Afternoon</option>
                            <option value="night">Night</option>
                        </select>
                    </div>
                </div>
                <div class="save-btn-container">
                    <button type="submit" class="save-item-btn">
                        <i class="fas fa-cloud-upload-alt"></i> Save to Menu
                    </button>
                </div>
            </form>

            <div class="manage-list-section"
                style="margin-top: 3rem; border-top: 2px dashed #f0f2f5; padding-top: 2rem;">
                <h4 style="font-size: 1.2rem; color: var(--primary); margin-bottom: 1.5rem;">
                    <i class="fas fa-list" style="color: var(--accent);"></i> Existing Menu Items
                </h4>
                <div id="manage-items-list" class="manage-items-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Managed items will be injected here -->
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted); grid-column: 1/-1;">
                        <i class="fas fa-spinner fa-spin"></i> Loading existing items...
                    </div>
                </div>
            </div>
        </section>

        <!-- Session Controls -->
        <div class="session-selector">
            <button class="session-btn morning active" onclick="switchSession('morning')">
                <i class="fas fa-sun"></i>
                <span>Morning</span>
            </button>
            <button class="session-btn afternoon" onclick="switchSession('afternoon')">
                <i class="fas fa-cloud-sun"></i>
                <span>Afternoon</span>
            </button>
            <button class="session-btn night" onclick="switchSession('night')">
                <i class="fas fa-moon"></i>
                <span>Night</span>
            </button>
        </div>



        <h2 class="section-title">Session Menu</h2>

        <div id="loading-overlay" class="loading-overlay">
            <span class="loader"></span>
            <p style="margin-top: 1rem;">Syncing with Firestore...</p>
        </div>

        <!-- Items Display -->
        <div id="items-container" class="items-grid">
            <!-- Items will be injected here -->
        </div>

        <!-- Recent Orders -->
        <h2 class="section-title">
            Recent Orders (Today)
            <button class="toggle-view-btn" onclick="window.toggleRecentOrders(this)" title="Toggle Recent Orders">
                <i class="fas fa-eye-slash"></i>
            </button>
        </h2>
        <div id="orders-list-container" class="orders-list" style="display: none;">
            <!-- Orders will be injected dynamically -->
            <div class="empty-state" style="padding: 1rem;">
                <p style="font-size: 0.9rem;">No orders yet today.</p>
            </div>
        </div>

        <!-- Floating Cart Button (Mobile) -->
        <div id="floating-cart" class="floating-cart-btn" onclick="window.toggleCart()">
            <i class="fas fa-receipt"></i>
            <div class="cart-badge" id="cart-count">0</div>
        </div>

        <!-- Digital Bill / Temporary Cart -->
        <section id="current-bill-panel" class="modal-card"
            style="display: none; background: #fff; color: var(--primary); border: 2px solid var(--accent); margin-top: 2rem;">
            <div class="summary-header"
                style="border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="window.toggleCart()"
                        style="background: #f8f9fa; border: 1px solid #ddd; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); cursor: pointer;">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <h2 style="color: var(--primary); margin: 0;"><i class="fas fa-receipt"
                            style="color: var(--accent);"></i> Ready to Bill</h2>
                </div>
                <button onclick="window.clearCart()"
                    style="background:none; border:none; color:#e74c3c; font-weight:600; cursor:pointer;">Clear
                    All</button>
            </div>

            <div id="current-bill-items"
                style="margin-bottom: 20px; max-height: 300px; overflow-y: auto; padding-right: 5px; -webkit-overflow-scrolling: touch;">
                <!-- Cart items injected here -->
            </div>

            <!-- Payment Method Inside Bill Panel -->
            <div class="payment-selector" style="margin-bottom: 15px; background: #f8f9fa; border: 1px solid #eee;">
                <button class="payment-btn cash active" onclick="window.switchPayment('cash')" id="bill-pay-cash"
                    style="padding: 10px; font-size: 0.85rem;">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Cash</span>
                </button>
                <button class="payment-btn online" onclick="window.switchPayment('online')" id="bill-pay-online"
                    style="padding: 10px; font-size: 0.85rem;">
                    <i class="fas fa-mobile-alt"></i>
                    <span>Online</span>
                </button>
            </div>

            <div
                style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 2px solid #f0f0f0;">
                <div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase;">Bill Total
                    </div>
                    <div id="bill-total-amount" style="font-size: 1.8rem; font-weight: 800; color: var(--primary);">0
                    </div>
                </div>
                <button id="confirm-bill-btn" class="save-item-btn" style="margin: 0; background: var(--success);"
                    onclick="window.confirmBill()">
                    <i class="fas fa-check-circle"></i> Confirm Order
                </button>
            </div>
        </section>

        <!-- Today's Summary -->
        <section class="summary-panel" style="padding: 12px 15px;">
            <div class="summary-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0;"><i class="fas fa-chart-pie" style="margin-right: 8px; font-size: 0.9rem;"></i>
                    Today's Summary</h2>
                <button id="toggle-summary-btn" onclick="window.toggleSummaryModal()"
                    style="background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </section>

        <!-- Today's Summary Modal -->
        <div id="summary-modal-bg" class="modal-overlay" onclick="window.toggleSummaryModal()"></div>
        <div id="summary-modal-panel" class="modal-card">
            <div class="modal-header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px;">
                <h3 style="margin:0; display:flex; align-items:center; gap:10px; color: var(--primary);">
                    <i class="fas fa-chart-line" style="color: var(--accent);"></i> Today's Sales
                </h3>
                <button onclick="window.toggleSummaryModal()" class="close-btn"
                    style="background:none; color:#999; border:none; font-size:1.5rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="summary-stats-popup" style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <div class="stat-box clickable" style="background: #f8fafc;"
                    onclick="window.toggleSummaryModal(); window.toggleHistoryView()" title="View History">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="summary-total-amount" style="font-size: 1.8rem;">0.00</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="stat-box"
                        style="background: rgba(39, 174, 96, 0.05); border-color: rgba(39, 174, 96, 0.1);">
                        <div class="stat-label">Cash</div>
                        <div class="stat-value" id="summary-cash-amount"
                            style="color: var(--success); font-size: 1.2rem;">0.00</div>
                    </div>
                    <div class="stat-box"
                        style="background: rgba(52, 152, 219, 0.05); border-color: rgba(52, 152, 219, 0.1);">
                        <div class="stat-label">Online</div>
                        <div class="stat-value" id="summary-online-amount" style="color: #3498db; font-size: 1.2rem;">
                            0.00</div>
                    </div>
                </div>
                <div class="stat-box" style="background: #fff; border-style: dashed;">
                    <div class="stat-label">Total Items Sold</div>
                    <div class="stat-value" id="summary-items-count" style="font-size: 1.2rem;">0</div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="save-item-btn" style="width:100%; margin: 0; background: var(--primary);"
                    onclick="window.toggleSummaryModal()">
                    <i class="fas fa-check"></i> Done
                </button>
            </div>
        </div>

        <!-- Monthly Analysis Panel -->
        <div id="modal-bg" class="modal-overlay" onclick="window.toggleMonthlyView()"></div>
        <div id="monthly-view-panel" class="monthly-card">
            <div class="monthly-header">
                <h3><i class="fas fa-file-invoice" style="color: var(--accent);"></i> Reports History</h3>
                <button class="close-btn" onclick="window.toggleMonthlyView()"
                    style="border:none; background:none; font-size:1.8rem; cursor:pointer; color: #999;">&times;</button>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="btn-daily-report" class="session-btn active" style="flex:1; padding: 8px;"
                    onclick="window.switchReportMode('daily')">Daily</button>
                <button id="btn-monthly-report" class="session-btn" style="flex:1; padding: 8px;"
                    onclick="window.switchReportMode('monthly')">Monthly</button>
            </div>

            <div class="month-picker-container" id="daily-picker-container">
                <input type="date" id="history-date-picker" class="month-input">
                <button class="save-item-btn" style="padding: 10px 15px; margin: 0; font-size: 0.9rem;"
                    onclick="window.fetchHistoryStats()">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div class="month-picker-container" id="monthly-picker-container" style="display: none;">
                <input type="month" id="history-month-picker" class="month-input">
                <button class="save-item-btn" style="padding: 10px 15px; margin: 0; font-size: 0.9rem;"
                    onclick="window.fetchHistoryStats()">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div id="monthly-results" class="monthly-grid" style="display: none;">
                <div class="month-stat">
                    <div class="month-label">Revenue</div>
                    <div class="month-value" id="m-revenue">0</div>
                </div>
                <div class="month-stat">
                    <div class="month-label">Cash</div>
                    <div class="month-value" id="m-cash" style="color: #27ae60;">0</div>
                </div>
                <div class="month-stat">
                    <div class="month-label">Online</div>
                    <div class="month-value" id="m-online" style="color: #3498db;">0</div>
                </div>
                <div class="month-stat">
                    <div class="month-label">Items</div>
                    <div class="month-value" id="m-count">0</div>
                </div>
            </div>

            <div id="month-loader" style="display:none; text-align:center; padding: 30px;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 1.8rem; color: var(--accent);"></i>
                <p style="margin-top: 10px; font-size: 0.9rem;">Fetching Data...</p>
            </div>

            <div id="month-no-data" style="display:none; text-align:center; padding: 20px; color: #888;">
                <p>No data found for this month.</p>
            </div>
        </div>
        <!-- Sidebar Menu -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="window.toggleSidebar()"></div>
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2>Amma Mess</h2>
                <button onclick="window.toggleSidebar()" class="close-btn" style="background:none; color:white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item" onclick="window.toggleSidebar()">
                    <i class="fas fa-home"></i> Home Dashboard
                </button>
                <button class="nav-item" onclick="window.togglePopularView(); window.toggleSidebar();">
                    <i class="fas fa-fire"></i> Most Popular
                </button>
                <button class="nav-item" onclick="window.toggleMonthlyView(); window.toggleSidebar();">
                    <i class="fas fa-calendar-day"></i> Reports History
                </button>
                <button class="nav-item" onclick="window.toggleManagePanel(); window.toggleSidebar();">
                    <i class="fas fa-utensils"></i> Manage Menu
                </button>
                <button class="nav-item" onclick="window.toggleHistoryView(); window.toggleSidebar();">
                    <i class="fas fa-history"></i> Sales History
                </button>
                <button class="nav-item" onclick="window.generatePDFReport(); window.toggleSidebar();">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <div
                    style="margin-top: auto; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; opacity: 0.5; text-align: center;">
                    Amma Mess v2.0
                </div>
            </nav>
        </div>

        <!-- Popular Items Modal -->
        <div id="popular-modal-bg" class="modal-overlay" onclick="window.togglePopularView()"></div>
        <div id="popular-items-panel" class="modal-card">
            <div class="modal-header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h3 style="margin:0; display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-fire" style="color: #e67e22;"></i> Most Popular Today
                </h3>
                <button onclick="window.togglePopularView()" class="close-btn" style="background:none; color:#ccc;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="top-selling-items-container">
                <!-- Data injected here -->
            </div>
            <div style="text-align:center; margin-top: 20px;">
                <button class="report-btn" style="width:100%; border-color: rgba(255,255,255,0.3);"
                    onclick="window.togglePopularView()">Close</button>
            </div>
        </div>
    </div>

    <!-- Detailed History Modal -->
    <div id="history-modal-bg" class="modal-overlay" onclick="window.toggleHistoryView()"></div>
    <div id="history-items-panel" class="modal-card">
        <div class="modal-header"
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin:0; display:flex; align-items:center; gap:10px; color: var(--primary);">
                <i class="fas fa-history" style="color: var(--accent);"></i> Detailed History
            </h3>
            <button onclick="window.toggleHistoryView()" class="close-btn" style="background:none; color:#999;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="history-scroll-area" id="detailed-history-container">
            <!-- Detailed Bills Injected Here -->
        </div>
        <div style="margin-top: 20px;">
            <button class="report-btn" style="width:100%;" onclick="window.toggleHistoryView()">Close</button>
        </div>
    </div>
    </div>

    <div id="toast">Order saved successfully!</div>

    <!-- Firebase SDKs (CDN Version) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            orderBy,
            onSnapshot,
            setDoc,
            doc,
            deleteDoc,
            updateDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. Firebase Configuration ---
        // REPLACE WITH YOUR OWN CONFIG FROM FIREBASE CONSOLE
        const firebaseConfig = {
            apiKey: "AIzaSyCU6pM8XGyBF15O_7Fe7pQSxZWtu4PG8ns",
            authDomain: "amma-mess.firebaseapp.com",
            projectId: "amma-mess",
            storageBucket: "amma-mess.firebasestorage.app",
            messagingSenderId: "744035726002",
            appId: "1:744035726002:web:2905c256baed62b2c6cfab"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 2. State & Constants ---
        let currentSession = 'morning';
        let currentPaymentMethod = 'cash';
        let editingItemId = null;
        let cart = []; // New: Temporary Cart
        window.currentItemStats = {}; // Global track for popular items
        const today = new Date().toISOString().split('T')[0];

        // Display today's date
        document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('en-GB', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        // --- 3. Core Functions ---

        /**
         * Toggle Menu Management Panel
         */
        window.toggleManagePanel = () => {
            const panel = document.getElementById('manage-panel');
            const isClosing = panel.style.display !== 'none';
            panel.style.display = isClosing ? 'none' : 'block';

            if (isClosing) {
                resetForm();
            } else {
                loadManageItemsList();
            }
        };

        async function loadManageItemsList() {
            const listContainer = document.getElementById('manage-items-list');
            if (!listContainer) return;

            listContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted); grid-column: 1/-1;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const q = query(collection(db, "items"), orderBy("name"));
                const querySnapshot = await getDocs(q);
                listContainer.innerHTML = '';

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">No items in menu yet.</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const item = docSnap.data();
                    const id = docSnap.id;
                    const row = document.createElement('div');
                    row.className = 'manage-item-row';
                    row.style.background = '#f8fafc';
                    row.style.padding = '12px';
                    row.style.borderRadius = '12px';
                    row.style.display = 'flex';
                    row.style.alignItems = 'center';
                    row.style.gap = '12px';
                    row.style.border = '1px solid #edf2f7';

                    row.innerHTML = `
                        <img src="${item.image || ''}" style="width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #eee;" onerror="this.src='https://via.placeholder.com/50'">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 700; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${item.session.toUpperCase()}  ${item.price}</div>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="window.editItem('${id}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.session}', '${item.image || ''}')" 
                                    style="border: none; background: #3498db; color: white; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-pencil-alt" style="font-size: 0.8rem;"></i>
                            </button>
                            <button onclick="window.deleteItem('${id}', '${item.name.replace(/'/g, "\\'")}')" 
                                    style="border: none; background: #e74c3c; color: white; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-trash" style="font-size: 0.8rem;"></i>
                            </button>
                        </div>
                    `;
                    listContainer.appendChild(row);
                });
            } catch (error) {
                console.error("Error loading manage list:", error);
                listContainer.innerHTML = '<p style="color: red; grid-column: 1/-1;">Error loading items.</p>';
            }
        }

        function resetForm() {
            editingItemId = null;
            document.getElementById('add-item-form').reset();
            const btn = document.querySelector('.save-item-btn');
            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Save to Menu';
            document.querySelector('.panel-header h3').innerHTML = '<i class="fas fa-plus-circle"></i> Add New Menu Item';
        }

        /**
         * Handle Add/Edit Item Form
         */
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-item-name').value;
            const price = parseFloat(document.getElementById('new-item-price').value);
            const image = document.getElementById('new-item-image').value || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=500&auto=format&fit=crop';
            const session = document.getElementById('new-item-session').value;
            const btn = e.target.querySelector('button');

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                if (editingItemId) {
                    await updateDoc(doc(db, "items", editingItemId), {
                        name, price, image, session
                    });
                    showToast(`"${name}" updated!`);
                } else {
                    await addDoc(collection(db, "items"), {
                        name, price, image, session
                    });
                    showToast(`"${name}" added!`);
                }

                resetForm();
                fetchItems(currentSession);
                loadManageItemsList();
            } catch (error) {
                console.error("Error saving item:", error);
                alert("Error saving item. Check console.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = editingItemId ? '<i class="fas fa-sync"></i> Update Item' : '<i class="fas fa-cloud-upload-alt"></i> Save to Menu';
            }
        });

        /**
         * Fetch items for the active session and render them
         */
        async function fetchItems(session) {
            const container = document.getElementById('items-container');
            const loader = document.getElementById('loading-overlay');

            // Don't clear immediately to avoid flicker if we're just updating stats
            if (!container.innerHTML) loader.style.display = 'flex';

            try {
                const q = query(collection(db, "items"), where("session", "==", session));
                const querySnapshot = await getDocs(q);

                loader.style.display = 'none';

                if (querySnapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-utensils"></i>
                            <p>No items found for ${session} session.</p>
                            <button onclick="window.seedDatabase()" style="margin-top: 1rem; border: none; background: #34495e; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                                Add Demo Items
                            </button>
                        </div>`;
                    return;
                }

                const itemsList = [];
                querySnapshot.forEach((doc) => {
                    itemsList.push({ id: doc.id, ...doc.data() });
                });

                // Sort by popularity (order count)
                itemsList.sort((a, b) => {
                    const countA = window.currentItemStats[a.name] || 0;
                    const countB = window.currentItemStats[b.name] || 0;
                    return countB - countA; // DESC order
                });

                // Get max count for badges
                const maxCount = Math.max(...Object.values(window.currentItemStats), 0);

                container.innerHTML = '';
                itemsList.forEach((item) => {
                    const isPopular = maxCount > 0 && (window.currentItemStats[item.name] || 0) >= (maxCount * 0.7) && (window.currentItemStats[item.name] > 0);
                    renderItemCard(item, item.id, isPopular);
                });
            } catch (error) {
                console.error("Error fetching items: ", error);
                container.innerHTML = `<p style="color: red; text-align: center;">Error connecting to Firestore. Please check your config.</p>`;
            }
        }

        /**
         * Create and append an item card to the UI
         */
        function renderItemCard(item, id, isPopular = false) {
            const container = document.getElementById('items-container');
            const card = document.createElement('div');
            card.className = `item-card ${isPopular ? 'is-popular' : ''}`;

            const imageUrl = item.image || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=500&auto=format&fit=crop';
            const popularBadge = isPopular ? `<div class="popular-badge"><i class="fas fa-fire"></i> Best Seller</div>` : '';

            card.innerHTML = `
                ${popularBadge}
                <img src="${imageUrl}" alt="${item.name}" class="item-image" onerror="this.src='https://via.placeholder.com/300x150?text=No+Image'">
                <div class="item-details">
                    <div class="item-info">
                        <h3>${item.name}</h3>
                        <div class="price">${item.price}</div>
                    </div>
                    <div class="item-controls-container">
                        <div class="qty-selector">
                            <button class="qty-btn" onclick="window.adjustQty('${item.name.replace(/\s+/g, '-')}', -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="qty-input" value="1" min="1" id="qty-${item.name.replace(/\s+/g, '-')}" onfocus="this.select()">
                            <button class="qty-btn" onclick="window.adjustQty('${item.name.replace(/\s+/g, '-')}', 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="item-controls">
                            <button class="add-btn" onclick="window.processOrder('${item.name}', ${item.price})">
                                <i class="fas fa-plus"></i> ADD
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

        window.adjustQty = (idName, amount) => {
            const input = document.getElementById(`qty-${idName}`);
            if (input) {
                let current = parseInt(input.value) || 1;
                let newValue = current + amount;
                if (newValue < 1) newValue = 1;
                input.value = newValue;
            }
        };

        window.deleteItem = async (id, name) => {
            if (confirm(`Are you sure you want to delete "${name}"?`)) {
                try {
                    await deleteDoc(doc(db, "items", id));
                    showToast(`"${name}" deleted.`);
                    fetchItems(currentSession);
                    loadManageItemsList();
                } catch (error) {
                    console.error("Error deleting item:", error);
                    alert("Delete failed.");
                }
            }
        };

        window.editItem = (id, name, price, session, image) => {
            editingItemId = id;
            document.getElementById('new-item-name').value = name;
            document.getElementById('new-item-price').value = price;
            document.getElementById('new-item-session').value = session;
            document.getElementById('new-item-image').value = image;

            // Show panel and focus
            document.getElementById('manage-panel').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update UI
            document.querySelector('.save-item-btn').innerHTML = '<i class="fas fa-sync"></i> Update Item';
            document.querySelector('.panel-header h3').innerHTML = `<i class="fas fa-edit"></i> Editing: ${name}`;
        };

        /**
         * Process and add item to temporary cart
         */
        window.processOrder = (name, price) => {
            const qtyInput = document.getElementById(`qty-${name.replace(/\s+/g, '-')}`);
            const quantity = parseInt(qtyInput.value) || 0;

            if (quantity <= 0) return;

            const existingItem = cart.find(item => item.name === name);
            if (existingItem) {
                existingItem.quantity += quantity;
                existingItem.total = existingItem.price * existingItem.quantity;
            } else {
                cart.push({
                    name: name,
                    price: price,
                    quantity: quantity,
                    total: price * quantity
                });
            }

            qtyInput.value = 1; // Reset qty
            renderCart();
            showToast(`Added ${quantity}x ${name} to bill`);
        };

        window.clearCart = () => {
            if (confirm("Clear all items from bill?")) {
                cart = [];
                renderCart();
            }
        };

        window.renderCart = () => {
            const cartContainer = document.getElementById('current-bill-items');
            const cartPanel = document.getElementById('current-bill-panel');
            const cartTotal = document.getElementById('bill-total-amount');
            const floatingCart = document.getElementById('floating-cart');
            const cartCount = document.getElementById('cart-count');

            if (cart.length === 0) {
                if (window.innerWidth > 768) {
                    cartPanel.style.display = 'none';
                } else {
                    cartPanel.classList.remove('open');
                    if (floatingCart) floatingCart.classList.remove('active');
                }
                return;
            }

            // Desktop view or mobile drawer logic
            if (window.innerWidth > 768) {
                cartPanel.style.display = 'block';
                if (floatingCart) floatingCart.classList.remove('active');
            } else {
                // On mobile, never set display:block directly to avoid flickering
                // The CSS media query with !important handles the display
                if (floatingCart) {
                    floatingCart.classList.add('active');
                    cartCount.textContent = cart.reduce((acc, item) => acc + item.quantity, 0);
                }
            }

            cartContainer.innerHTML = '';
            let total = 0;

            cart.forEach((item, index) => {
                total += item.total;
                const div = document.createElement('div');
                div.className = 'order-item';
                div.style.borderBottom = '1px solid #f0f0f0';
                div.innerHTML = `
                    <div class="order-details-row">
                        <div class="order-main-info">
                            <span class="order-name-qty" style="font-size: 0.9rem;">${item.name} (x${item.quantity})</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="order-total-price" style="font-size: 0.9rem;">${item.total}</span>
                            <button class="delete-order-btn" onclick="window.removeFromCart(${index})" style="font-size: 0.9rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                cartContainer.appendChild(div);
            });

            cartTotal.textContent = `${total.toLocaleString('en-IN')}`;
        };

        window.toggleCart = () => {
            const cartPanel = document.getElementById('current-bill-panel');
            cartPanel.classList.toggle('open');
        };

        window.removeFromCart = (index) => {
            cart.splice(index, 1);
            renderCart();
            if (cart.length === 0 && window.innerWidth <= 768) {
                document.getElementById('current-bill-panel').classList.remove('open');
            }
        };

        window.confirmBill = async () => {
            if (cart.length === 0) return;

            const btn = document.getElementById('confirm-bill-btn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                const totalBill = cart.reduce((sum, i) => sum + i.total, 0);
                const totalQty = cart.reduce((sum, i) => sum + i.quantity, 0);

                // Save as a single Bill document
                await addDoc(collection(db, "orders"), {
                    items: cart,
                    name: `Bill (${cart.length} items)`,
                    total: totalBill,
                    quantity: totalQty,
                    session: currentSession,
                    paymentMethod: currentPaymentMethod,
                    date: today,
                    timestamp: serverTimestamp()
                });

                showToast("Bill Confirmed & Saved!");
                cart = [];
                if (window.innerWidth <= 768) {
                    document.getElementById('current-bill-panel').classList.remove('open');
                }
                renderCart();
            } catch (error) {
                console.error("Error confirming bill:", error);
                alert("Failed to save bill.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        /**
         * Update Summary Real-time
         */
        function startSummaryListener() {
            const q = query(
                collection(db, "orders"),
                where("date", "==", today)
            );
            const ordersListContainer = document.getElementById('orders-list-container');

            onSnapshot(q, (snapshot) => {
                let totalAmount = 0;
                let cashAmount = 0;
                let onlineAmount = 0;
                let totalItems = 0;

                ordersListContainer.innerHTML = '';

                if (snapshot.empty) {
                    ordersListContainer.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p style="font-size: 0.9rem;">No orders yet today.</p></div>';
                }

                // Manual sorting in memory to avoid Firebase Index requirement
                const docs = [];
                snapshot.forEach(d => docs.push({ id: d.id, ...d.data() }));
                docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0) || b.timestamp - a.timestamp);

                let currentIndex = 1;
                let lastSession = '';

                docs.forEach((order) => {
                    const orderId = order.id;
                    const amount = (order.total || 0);
                    const qty = (order.quantity || 0);

                    totalAmount += amount;
                    totalItems += qty;

                    if (order.paymentMethod === 'online') {
                        onlineAmount += amount;
                    } else {
                        cashAmount += amount;
                    }

                    // Add Session Header "Break"
                    if (order.session !== lastSession) {
                        const header = document.createElement('div');
                        header.className = 'session-group-header';
                        const icon = order.session === 'morning' ? 'fa-sun' : (order.session === 'afternoon' ? 'fa-cloud-sun' : 'fa-moon');
                        header.innerHTML = `<i class="fas ${icon}"></i> ${order.session} Sales`;
                        ordersListContainer.appendChild(header);
                        lastSession = order.session;
                    }

                    // Format time if timestamp exists
                    let timeStr = "";
                    if (order.timestamp) {
                        try {
                            const date = order.timestamp.toDate ? order.timestamp.toDate() : new Date(order.timestamp);
                            timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        } catch (e) { }
                    }

                    // Build Summary String for history
                    let summaryText = order.name || 'Order';
                    if (order.items && order.items.length > 0) {
                        summaryText = order.items.map(i => `${i.name} (x${i.quantity})`).join(', ');
                    }

                    // Render order item in line-wise mode
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                        <div class="order-num">#${docs.length - (currentIndex - 1)}</div>
                        <div class="payment-status-dot dot-${order.paymentMethod || 'cash'}" title="${order.paymentMethod}"></div>
                        <div class="order-details-row">
                            <div class="order-main-info" style="flex: 1; overflow: hidden;">
                                <span class="order-name-qty" style="font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 180px;">
                                    ${summaryText}
                                </span>
                                ${timeStr ? `<span class="order-time-tag" style="font-size: 0.65rem;">${timeStr}</span>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="order-total-price" style="font-size: 0.8rem; font-weight: 800;">${amount}</span>
                                <button class="delete-order-btn" onclick="window.deleteOrder('${orderId}', 'Bill #${docs.length - (currentIndex - 1)}')" style="font-size: 0.8rem;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    ordersListContainer.appendChild(orderItem);
                    currentIndex++;
                });

                document.getElementById('summary-total-amount').textContent = `${totalAmount.toLocaleString('en-IN')}`;
                document.getElementById('summary-cash-amount').textContent = `${cashAmount.toLocaleString('en-IN')}`;
                document.getElementById('summary-online-amount').textContent = `${onlineAmount.toLocaleString('en-IN')}`;
                document.getElementById('summary-items-count').textContent = totalItems;

                // --- Calculate & Render Top Selling Items ---
                const itemStats = {};
                docs.forEach(order => {
                    if (order.items) {
                        order.items.forEach(item => {
                            const itemName = item.name || 'Unknown';
                            const qty = parseInt(item.quantity) || 0;
                            itemStats[itemName] = (itemStats[itemName] || 0) + qty;
                        });
                    } else {
                        // Backward compatibility
                        const itemName = order.name || 'Unknown';
                        const qty = parseInt(order.quantity) || 0;
                        itemStats[itemName] = (itemStats[itemName] || 0) + qty;
                    }
                });

                // --- Populate Detailed History Modal ---
                const detailedHistoryContainer = document.getElementById('detailed-history-container');
                if (detailedHistoryContainer) {
                    detailedHistoryContainer.innerHTML = '';
                    if (docs.length === 0) {
                        detailedHistoryContainer.innerHTML = '<p style="text-align:center; opacity:0.5; padding:20px;">No sales recorded yet today.</p>';
                    } else {
                        docs.forEach((order, idx) => {
                            let timeStr = "---";
                            if (order.timestamp) {
                                try {
                                    const date = order.timestamp.toDate ? order.timestamp.toDate() : new Date(order.timestamp);
                                    timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                } catch (e) { }
                            }

                            const billCard = document.createElement('div');
                            billCard.className = 'detailed-bill-card';

                            let itemsHTML = '';
                            if (order.items) {
                                order.items.forEach(it => {
                                    itemsHTML += `<div class="bill-item-row"><span>${it.name} (x${it.quantity})</span><span>${it.total}</span></div>`;
                                });
                            } else {
                                itemsHTML = `<div class="bill-item-row"><span>${order.name} (x${order.quantity})</span><span>${order.total}</span></div>`;
                            }

                            billCard.innerHTML = `
                                <div class="bill-header">
                                    <span class="bill-id">#${docs.length - idx} Bill</span>
                                    <span class="bill-time"><i class="far fa-clock"></i> ${timeStr}</span>
                                </div>
                                <div class="bill-items-list">${itemsHTML}</div>
                                <div class="bill-footer">
                                    <span style="font-size:0.7rem; color:${order.paymentMethod === 'online' ? '#3498db' : '#27ae60'}">
                                        <i class="fas fa-credit-card"></i> ${order.paymentMethod?.toUpperCase() || 'CASH'}
                                    </span>
                                    <span>Total: ${order.total}</span>
                                </div>
                            `;
                            detailedHistoryContainer.appendChild(billCard);
                        });
                    }
                }

                const sortedItems = Object.entries(itemStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5); // Show top 5

                const topItemsContainer = document.getElementById('top-selling-items-container');
                if (topItemsContainer) {
                    topItemsContainer.innerHTML = '';
                    const maxQty = sortedItems.length > 0 ? sortedItems[0][1] : 0;

                    if (sortedItems.length === 0) {
                        topItemsContainer.innerHTML = '<p style="font-size: 0.8rem; opacity: 0.6; text-align: center; padding: 10px;">No items sold yet today.</p>';
                    } else {
                        sortedItems.forEach(([name, qty]) => {
                            const width = maxQty > 0 ? (qty / maxQty) * 100 : 0;
                            topItemsContainer.innerHTML += `
                                <div class="top-item-row">
                                    <div class="top-item-info">
                                        <span>${name}</span>
                                        <span>${qty} Qty</span>
                                    </div>
                                    <div class="top-item-bar-bg">
                                        <div class="top-item-bar-fill" style="width: ${width}%"></div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }

                // Store global item stats for menu sorting
                window.currentItemStats = itemStats;

                // Refresh menu to apply sorting and popular badges
                fetchItems(currentSession);

                // Store today's data globally for PDF generation
                window.todayOrders = docs;
            });
        }

        /**
         * PDF Report Generation using jsPDF
         */
        window.generatePDFReport = () => {
            if (!window.todayOrders || window.todayOrders.length === 0) {
                alert("No orders to export for today.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(22);
            doc.setTextColor(44, 62, 80);
            doc.text("Amma Mess Sales Report", 14, 20);

            doc.setFontSize(12);
            doc.setTextColor(127, 140, 141);
            doc.text(`Date: ${new Date().toLocaleDateString('en-GB')}`, 14, 30);

            const sessions = ['morning', 'afternoon', 'night'];
            let currentY = 40;

            sessions.forEach(session => {
                const sessionOrders = window.todayOrders.filter(o => (o.session || 'morning') === session);

                if (sessionOrders.length > 0) {
                    // Session Header
                    doc.setFontSize(16);
                    doc.setTextColor(230, 126, 34);
                    doc.text(`${session.charAt(0).toUpperCase() + session.slice(1)} Sales`, 14, currentY);
                    currentY += 5;

                    const tableData = [];
                    sessionOrders.forEach(o => {
                        if (o.items) {
                            o.items.forEach(item => {
                                tableData.push([
                                    '', // No individual number to keep it grouped visually
                                    item.name,
                                    item.quantity,
                                    `Rs. ${item.price}`,
                                    `Rs. ${item.total}`,
                                    o.paymentMethod?.toUpperCase() || 'CASH'
                                ]);
                            });
                            // Add a separator or subtotal if needed, but keeping it simple for now
                        } else {
                            tableData.push([
                                '',
                                o.name,
                                o.quantity,
                                `Rs. ${o.price}`,
                                `Rs. ${o.total}`,
                                o.paymentMethod?.toUpperCase() || 'CASH'
                            ]);
                        }
                    });

                    doc.autoTable({
                        startY: currentY,
                        head: [['#', 'Item Name', 'Qty', 'Price', 'Total', 'Payment']],
                        body: tableData,
                        theme: 'striped',
                        headStyles: { fillColor: [44, 62, 80] },
                    });

                    currentY = doc.lastAutoTable.finalY + 15;

                    if (currentY > 260) {
                        doc.addPage();
                        currentY = 20;
                    }
                }
            });

            // Footer Summary
            doc.setFontSize(14);
            doc.setTextColor(44, 62, 80);
            const totalText = document.getElementById('summary-total-amount').textContent.replace('', 'Rs. ');
            const cashText = document.getElementById('summary-cash-amount').textContent.replace('', 'Rs. ');
            const onlineText = document.getElementById('summary-online-amount').textContent.replace('', 'Rs. ');

            doc.text(`Total Sales: ${totalText}`, 14, currentY);
            doc.text(`Cash Total: ${cashText}`, 14, currentY + 8);
            doc.text(`Online Total: ${onlineText}`, 14, currentY + 16);

            // Save
            doc.save(`Amma_Mess_Report_${today}.pdf`);
            showToast("PDF Downloaded with Session Breaks!");
        };

        window.togglePopularView = () => {
            const panel = document.getElementById('popular-items-panel');
            const bg = document.getElementById('popular-modal-bg');
            const isShowing = panel.style.display === 'block';

            if (isShowing) {
                panel.style.display = 'none';
                bg.style.display = 'none';
            } else {
                panel.style.display = 'block';
                bg.style.display = 'block';
            }
        };

        window.toggleRecentOrders = (btn) => {
            const container = document.getElementById('orders-list-container');
            const icon = btn.querySelector('i');
            const isHidden = container.style.display === 'none';

            if (isHidden) {
                container.style.display = 'block';
                icon.className = 'fas fa-eye';
                btn.classList.add('active');
            } else {
                container.style.display = 'none';
                icon.className = 'fas fa-eye-slash';
                btn.classList.remove('active');
            }
        };

        window.toggleHistoryView = () => {
            const panel = document.getElementById('history-items-panel');
            const bg = document.getElementById('history-modal-bg');
            const isShowing = panel.classList.contains('open');

            if (isShowing) {
                panel.classList.remove('open');
                panel.style.display = 'none';
                bg.style.display = 'none';
            } else {
                panel.classList.add('open');
                panel.style.display = 'flex';
                bg.style.display = 'block';
            }
        };

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = sidebar.classList.contains('open');

            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.style.display = 'none';
            } else {
                sidebar.classList.add('open');
                overlay.style.display = 'block';
            }
        };

        /**
         * Monthly Stats Logic
         */
        window.toggleMonthlyView = () => {
            const panel = document.getElementById('monthly-view-panel');
            const bg = document.getElementById('modal-bg');
            const isShowing = panel.style.display === 'block';

            if (isShowing) {
                panel.style.display = 'none';
                if (bg) bg.style.display = 'none';
            } else {
                panel.style.display = 'block';
                if (bg) bg.style.display = 'block';

                // Pre-fill and auto-fetch
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                document.getElementById('history-date-picker').value = dateStr;
                window.fetchHistoryStats();
            }
        };

        let reportMode = 'daily';
        window.switchReportMode = (mode) => {
            reportMode = mode;
            document.getElementById('btn-daily-report').classList.toggle('active', mode === 'daily');
            document.getElementById('btn-monthly-report').classList.toggle('active', mode === 'monthly');
            document.getElementById('daily-picker-container').style.display = mode === 'daily' ? 'flex' : 'none';
            document.getElementById('monthly-picker-container').style.display = mode === 'monthly' ? 'flex' : 'none';
            document.getElementById('monthly-results').style.display = 'none';
        };

        window.fetchHistoryStats = async () => {
            const dateInput = document.getElementById('history-date-picker').value;
            const monthInput = document.getElementById('history-month-picker').value;

            const target = reportMode === 'daily' ? dateInput : monthInput;
            if (!target) return;

            const loader = document.getElementById('month-loader');
            const results = document.getElementById('monthly-results');
            const noData = document.getElementById('month-no-data');

            // Show loading
            loader.style.display = 'block';
            results.style.display = 'none';
            if (noData) noData.style.display = 'none';

            try {
                // For monthly, we fetch all and filter client-side for simplicity/no-extra-index
                // or we could use where with >= and < but date strings make it tricky.
                // Re-using the manual filtering logic.
                const q = query(collection(db, "orders"));
                const querySnapshot = await getDocs(q);

                let rev = 0, csh = 0, onl = 0, cnt = 0;

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const orderDate = data.date; // YYYY-MM-DD

                    if (reportMode === 'daily' && orderDate === dateInput) {
                        rev += (data.total || 0);
                        cnt += (data.quantity || 0);
                        if (data.paymentMethod === 'online') onl += (data.total || 0);
                        else csh += (data.total || 0);
                    } else if (reportMode === 'monthly' && orderDate && orderDate.startsWith(monthInput)) {
                        rev += (data.total || 0);
                        cnt += (data.quantity || 0);
                        if (data.paymentMethod === 'online') onl += (data.total || 0);
                        else csh += (data.total || 0);
                    }
                });

                loader.style.display = 'none';

                if (rev === 0) {
                    if (noData) noData.style.display = 'block';
                } else {
                    document.getElementById('m-revenue').textContent = `${rev.toLocaleString('en-IN')}`;
                    document.getElementById('m-cash').textContent = `${csh.toLocaleString('en-IN')}`;
                    document.getElementById('m-online').textContent = `${onl.toLocaleString('en-IN')}`;
                    document.getElementById('m-count').textContent = cnt;
                    results.style.display = 'grid';
                }
            } catch (err) {
                console.error("Monthly Fetch Error:", err);
                loader.style.display = 'none';
                alert("Data sync error. Please try again.");
            }
        };

        /**
         * Delete an order
         */
        window.deleteOrder = async (id, name) => {
            if (confirm(`Remove this ${name}?`)) {
                try {
                    await deleteDoc(doc(db, "orders", id));
                    showToast(`${name} removed.`);
                } catch (error) {
                    console.error("Error deleting order:", error);
                    alert("Failed to remove order.");
                }
            }
        };

        /**
         * Switch Payment Method
         */
        window.switchPayment = (method) => {
            currentPaymentMethod = method;

            // Update payment buttons in the bill panel
            document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('active'));

            if (method === 'cash') {
                const billBtn = document.getElementById('bill-pay-cash');
                if (billBtn) billBtn.classList.add('active');
            } else {
                const billBtn = document.getElementById('bill-pay-online');
                if (billBtn) billBtn.classList.add('active');
            }
        };

        /**
         * Switch between sessions
         */
        window.switchSession = (session) => {
            currentSession = session;

            // Update UI buttons
            document.querySelectorAll('.session-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(session)) btn.classList.add('active');
            });

            fetchItems(session);
        };

        /**
         * Helper for Toast with robust timeout
         */
        window.toggleSummaryModal = () => {
            const panel = document.getElementById('summary-modal-panel');
            const bg = document.getElementById('summary-modal-bg');
            const isShowing = panel.style.display === 'block';

            if (isShowing) {
                panel.style.display = 'none';
                if (bg) bg.style.display = 'none';
            } else {
                panel.style.display = 'block';
                if (bg) bg.style.display = 'block';
            }
        };

        let toastTimeout;
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');

            if (toastTimeout) clearTimeout(toastTimeout);

            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        /**
         * Seed Database with initial items (Demo)
         */
        window.seedDatabase = async () => {
            const items = [
                { name: "Masala Dosa", price: 60, session: "morning", image: "https://images.unsplash.com/photo-1589301760014-d929f3979dbc?w=500&auto=format&fit=crop" },
                { name: "Idli (2pcs)", price: 40, session: "morning", image: "https://images.unsplash.com/photo-1589301773839-9d7a9616d6ae?w=500&auto=format&fit=crop" },
                { name: "Coffee/Tea", price: 20, session: "morning", image: "https://images.unsplash.com/photo-1544787210-2211d40fd812?w=500&auto=format&fit=crop" },
                { name: "Veg Meals", price: 120, session: "afternoon", image: "https://images.unsplash.com/photo-1585937421612-70a008356fbe?w=500&auto=format&fit=crop" },
                { name: "Chicken Biryani", price: 220, session: "afternoon", image: "https://images.unsplash.com/photo-1589302168068-964664d93dc0?w=500&auto=format&fit=crop" },
                { name: "Curd Rice", price: 80, session: "afternoon", image: "https://images.unsplash.com/photo-1626777551341-10492ec663d8?w=500&auto=format&fit=crop" },
                { name: "Roti with Curry", price: 100, session: "night", image: "https://images.unsplash.com/photo-1565557623262-b51c2513a641?w=500&auto=format&fit=crop" },
                { name: "Fried Rice", price: 150, session: "night", image: "https://images.unsplash.com/photo-1603133872878-684f208fb84b?w=500&auto=format&fit=crop" },
                { name: "Fruit Salad", price: 90, session: "night", image: "https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=500&auto=format&fit=crop" }
            ];

            if (confirm("This will add demo items to your 'items' collection. Continue?")) {
                try {
                    for (const item of items) {
                        await addDoc(collection(db, "items"), item);
                    }
                    alert("Demo items added successfully!");
                    fetchItems(currentSession);
                } catch (e) {
                    alert("Error seeding: " + e.message);
                }
            }
        };

        // Initialize App
        fetchItems(currentSession);
        startSummaryListener();

    </script>
</body>

</html>